<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- 省略（スタイルはそのまま） -->
</head>
<body>
  <!-- カスタム音声ファイル -->
  <audio id="customSound" src="./sound.mp3" preload="auto"></audio>

  <div id="buttons">…</div>
  <button id="ack">了解!!</button>
  <div id="qrcode"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Firebase 初期化〜セッション取得はそのまま
    const app = initializeApp({/* config */});
    const db  = getDatabase(app);
    const params   = new URLSearchParams(location.search);
    let   sessionId= params.get('session') || Math.random().toString(36).substr(2,8);
    const isViewer= params.get('viewer')==='1';
    history.replaceState(null,'',`?session=${sessionId}${isViewer?'&viewer=1':''}`);

    // Realtime DB 参照
    const menuRef = ref(db, `sessions/${sessionId}/buttons`);
    const ackRef  = ref(db, `sessions/${sessionId}/ack`);
    const buttons = document.querySelectorAll('.btn');
    const ackBtn  = document.getElementById('ack');
    const audioEl = document.getElementById('customSound');
    let   audioReady = false;

    // ——【変更①】——
    // ビューアーは最初のどこか一回クリックで音声を有効化
    if (isViewer) {
      document.body.addEventListener('click', () => {
        if (!audioReady) {
          audioEl.play().catch(()=>{}); // 空再生で許可を得る
          audioEl.pause();
          audioReady = true;
        }
      }, { once: true });
    }

    // ——【変更②】——
    // 了解ボタンは常に表示、マスターは無効、ビューアーは有効
    if (isViewer) {
      ackBtn.classList.remove('disabled');
      ackBtn.addEventListener('click', () => {
        set(ackRef, true);
        setTimeout(()=> set(ackRef, false), 10000);
      });
    } else {
      ackBtn.classList.add('disabled');
      buttons.forEach(b => b.addEventListener('click', () => {
        const key = b.dataset.key;
        runTransaction(ref(db, `sessions/${sessionId}/buttons/${key}`), c=>c?0:1);
      }));
    }

    // メニュー同期と音声再生
    let prevMenu = {};
    onValue(menuRef, snap => {
      const data = snap.val()||{};
      buttons.forEach(b => {
        const key = b.dataset.key;
        const now = data[key]===1;
        b.classList.toggle('active', now);
        if (isViewer && audioReady && !prevMenu[key] && now) {
          audioEl.currentTime = 0;
          audioEl.play().catch(()=>{});
        }
      });
      prevMenu = {...data};
    });

    // 了解同期
    onValue(ackRef, snap => {
      ackBtn.classList.toggle('ack-active', snap.val()===true);
    });

    // QRコード生成はそのまま…
  </script>
</body>
</html>
